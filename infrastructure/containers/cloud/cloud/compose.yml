volumes:
  certificates:
  certbot_secrets:
  certbot_data:
  config:

networks:
  registry_internal:
    name: registry_internal

services:
  nginx:
    image: nginx
    ports:
      - 80:80
      - 443:443
    networks:
      - default
      - registry_internal
    volumes:
      - certificates:/certificates:ro
      - config:/config:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
        #user: root
    command: nginx -p / -e /dev/stderr -c /config/nginx.conf

  certbot:
    # todo use guix certbot
      #image: certbot
    image: docker.io/certbot/dns-cloudflare
    volumes:
      - certificates:/etc/letsencrypt
      - certbot_data:/var/lib/letsencrypt
      - certbot_secrets:/secrets
        # todo register with email maybe?
    command: certonly -n --agree-tos --register-unsafely-without-email -d *.web.cloud.griffinht.com --dns-cloudflare --dns-cloudflare-credentials /secrets/credentials.ini
      # setup: follow this guide and put credentials in certificates_secrets credentials.ini file (chmod 600 to avoid warnings)
      # https://certbot-dns-cloudflare.readthedocs.io/en/stable/
